<% content_for :title, "MCP Setup" %>

<div class="mx-auto max-w-3xl">
  <div class="mb-8">
    <h1 class="section-header">MCP Setup</h1>
    <p class="section-subheader">Connect Vault to Claude Desktop or Cursor</p>
  </div>

  <div class="space-y-6">
    <!-- Token Section -->
    <div class="card p-6">
      <div class="flex items-center mb-4">
        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-orange-100">
          <svg class="h-5 w-5 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
          </svg>
        </div>
        <div class="ml-3">
          <h2 class="text-lg font-semibold text-stone-900">API Token</h2>
          <p class="text-sm text-stone-500">Use this token to authenticate MCP requests</p>
        </div>
      </div>

      <div>
        <% if @raw_token %>
          <div class="alert-warning mb-4">
            <div class="flex">
              <svg class="h-5 w-5 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
              </svg>
              <div class="ml-3">
                <p class="text-sm text-amber-800">
                  <strong>Save this token now!</strong> You won't be able to see it again.
                </p>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <code class="code-block flex-1 break-all" data-controller="clipboard" data-clipboard-text="<%= @raw_token %>">
              <%= @raw_token %>
            </code>
            <button type="button" class="btn-secondary" data-action="clipboard#copy">
              Copy
            </button>
          </div>
        <% else %>
          <div class="flex items-center justify-between p-4 bg-stone-50 rounded-lg">
            <div>
              <p class="text-sm font-medium text-stone-900"><%= @token.name %></p>
              <p class="text-xs text-stone-500">Created <%= time_ago_in_words(@token.created_at) %> ago</p>
            </div>
            <%= button_to "Regenerate", regenerate_dashboard_project_access_token_path(@project, @token),
                method: :post,
                data: { confirm: "This will invalidate the existing token. Continue?" },
                class: "btn-secondary" %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Claude Desktop Config -->
    <div class="card p-6">
      <div class="flex items-center mb-4">
        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-sky-100">
          <svg class="h-5 w-5 text-sky-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25m18 0A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25m18 0V12a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12V5.25" />
          </svg>
        </div>
        <div class="ml-3">
          <h2 class="text-lg font-semibold text-stone-900">Claude Desktop Configuration</h2>
          <p class="text-sm text-stone-500">Add this to your Claude Desktop config file</p>
        </div>
      </div>

      <div>
        <p class="text-xs text-stone-500 mb-2">Config file: <code class="bg-stone-100 px-1.5 py-0.5 rounded text-stone-700">~/.config/claude-desktop/config.json</code></p>
        <pre class="code-block"><code>{
  "mcpServers": {
    "vault": {
      "url": "<%= request.base_url %>/mcp/rpc",
      "headers": {
        "Authorization": "Bearer <%= @raw_token || 'YOUR_TOKEN_HERE' %>"
      }
    }
  }
}</code></pre>
      </div>
    </div>

    <!-- Cursor Config -->
    <div class="card p-6">
      <div class="flex items-center mb-4">
        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-violet-100">
          <svg class="h-5 w-5 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
          </svg>
        </div>
        <div class="ml-3">
          <h2 class="text-lg font-semibold text-stone-900">Cursor Configuration</h2>
          <p class="text-sm text-stone-500">Add this to your Cursor MCP settings</p>
        </div>
      </div>

      <div>
        <p class="text-xs text-stone-500 mb-2">Config file: <code class="bg-stone-100 px-1.5 py-0.5 rounded text-stone-700">~/.cursor/mcp.json</code></p>
        <pre class="code-block"><code>{
  "vault": {
    "url": "<%= request.base_url %>/mcp/rpc",
    "apiKey": "<%= @raw_token || 'YOUR_TOKEN_HERE' %>"
  }
}</code></pre>
      </div>
    </div>

    <!-- Available Tools -->
    <div class="card p-6">
      <div class="flex items-center mb-4">
        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-100">
          <svg class="h-5 w-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z" />
          </svg>
        </div>
        <div class="ml-3">
          <h2 class="text-lg font-semibold text-stone-900">Available MCP Tools</h2>
          <p class="text-sm text-stone-500">These tools are available to AI assistants</p>
        </div>
      </div>

      <ul class="divide-y divide-stone-100">
        <li class="py-4 flex items-start">
          <code class="badge-orange font-mono mr-3">vault_list_secrets</code>
          <p class="text-sm text-stone-600">List all secret names in the vault</p>
        </li>
        <li class="py-4 flex items-start">
          <code class="badge-orange font-mono mr-3">vault_get_secret</code>
          <p class="text-sm text-stone-600">Retrieve a secret value by key</p>
        </li>
        <li class="py-4 flex items-start">
          <code class="badge-orange font-mono mr-3">vault_set_secret</code>
          <p class="text-sm text-stone-600">Create or update a secret</p>
        </li>
        <li class="py-4 flex items-start">
          <code class="badge-orange font-mono mr-3">vault_delete_secret</code>
          <p class="text-sm text-stone-600">Archive (soft-delete) a secret</p>
        </li>
        <li class="py-4 flex items-start">
          <code class="badge-orange font-mono mr-3">vault_list_environments</code>
          <p class="text-sm text-stone-600">List available environments</p>
        </li>
        <li class="py-4 flex items-start">
          <code class="badge-orange font-mono mr-3">vault_export</code>
          <p class="text-sm text-stone-600">Export secrets in various formats</p>
        </li>
        <li class="py-4 flex items-start">
          <code class="badge-orange font-mono mr-3">vault_import</code>
          <p class="text-sm text-stone-600">Import secrets from .env or JSON</p>
        </li>
      </ul>
    </div>
  </div>
</div>
