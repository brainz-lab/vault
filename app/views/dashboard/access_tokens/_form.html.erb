<%= form_with model: [@current_project, token], url: token.persisted? ? dashboard_project_access_token_path(@current_project, token) : dashboard_project_access_tokens_path(@current_project), class: "card mt-8 p-6 space-y-6" do |f| %>
  <% if token.errors.any? %>
    <div class="alert-error">
      <ul class="list-disc list-inside text-sm text-red-700">
        <% token.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= f.label :name, class: "form-label" %>
    <%= f.text_field :name, class: "form-input", placeholder: "CI/CD Token" %>
  </div>

  <div>
    <%= f.label :description, class: "form-label" %>
    <%= f.text_field :description, class: "form-input", placeholder: "Used for GitHub Actions deployments" %>
  </div>

  <div>
    <span class="form-label">Permissions</span>
    <div class="mt-2 space-y-3 rounded-lg border border-stone-200 p-4 bg-stone-50">
      <% %w[read write delete].each do |perm| %>
        <label class="flex items-start cursor-pointer group">
          <%= check_box_tag "access_token[permissions][]", perm, (token.permissions || []).include?(perm),
              class: "form-checkbox mt-0.5" %>
          <span class="ml-3">
            <span class="block text-sm font-medium text-stone-900 group-hover:text-orange-600 transition-colors"><%= perm.capitalize %></span>
            <span class="block text-xs text-stone-500">
              <%= case perm
                  when "read" then "Read secret values"
                  when "write" then "Create and update secrets"
                  when "delete" then "Delete secrets"
                  end %>
            </span>
          </span>
        </label>
      <% end %>
    </div>
  </div>

  <div>
    <span class="form-label">Environment Access</span>
    <div class="mt-2 space-y-3 rounded-lg border border-stone-200 p-4 bg-stone-50">
      <% @current_project.secret_environments.order(:position).each do |env| %>
        <label class="flex items-center cursor-pointer group">
          <%= check_box_tag "access_token[environments][]", env.slug, (token.environments || []).include?(env.slug),
              class: "form-checkbox" %>
          <div class="ml-3 flex items-center">
            <div class="flex h-6 w-6 items-center justify-center rounded <%= env.locked? ? 'bg-red-100' : 'bg-emerald-100' %> mr-2">
              <svg class="h-3.5 w-3.5 <%= env.locked? ? 'text-red-600' : 'text-emerald-600' %>" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <% if env.locked? %>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                <% else %>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                <% end %>
              </svg>
            </div>
            <span class="text-sm text-stone-700 group-hover:text-orange-600 transition-colors"><%= env.name %></span>
          </div>
        </label>
      <% end %>
    </div>
    <p class="form-hint">Leave unchecked to allow access to all environments</p>
  </div>

  <div>
    <%= f.label :expires_at, "Expiration Date", class: "form-label" %>
    <%= f.datetime_local_field :expires_at, class: "form-input" %>
    <p class="form-hint">Leave blank for no expiration</p>
  </div>

  <div class="flex justify-end gap-3 pt-6 border-t border-stone-100">
    <%= link_to "Cancel", dashboard_project_access_tokens_path(@current_project), class: "btn-secondary" %>
    <%= f.submit token.persisted? ? "Update Token" : "Create Token", class: "btn-primary cursor-pointer" %>
  </div>
<% end %>
