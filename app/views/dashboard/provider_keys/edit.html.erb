<% content_for :title, "Edit Provider Key" %>

<div class="mx-auto max-w-2xl">
  <div class="mb-8">
    <h1 class="section-header">Edit Provider Key</h1>
    <p class="section-subheader">Update <span class="font-medium"><%= @provider_key.name %></span></p>
  </div>

  <div class="card p-6">
    <%= form_with model: @provider_key, url: dashboard_provider_key_path(@provider_key, project_id: current_project&.id), method: :patch, class: "space-y-6" do |form| %>
      <% if @provider_key.errors.any? %>
        <div class="rounded-xl p-4 bg-red-50 border border-red-100">
          <p class="text-sm font-medium text-red-800"><%= pluralize(@provider_key.errors.count, "error") %> prevented this key from being saved:</p>
          <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
            <% @provider_key.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div>
        <%= form.label :name, class: "block text-sm font-medium text-stone-700 mb-2" %>
        <%= form.text_field :name,
            class: "w-full rounded-xl px-4 py-3 text-sm border border-stone-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 transition" %>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <%= form.label :provider, class: "block text-sm font-medium text-stone-700 mb-2" %>
          <%= form.select :provider,
              ProviderKey::PROVIDERS.map { |p| [p.titleize, p] },
              {},
              class: "w-full rounded-xl px-4 py-3 text-sm border border-stone-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 transition cursor-pointer" %>
        </div>

        <div>
          <%= form.label :model_type, "Model Type", class: "block text-sm font-medium text-stone-700 mb-2" %>
          <%= form.select :model_type,
              ProviderKey::MODEL_TYPES.map { |t| [t.upcase, t] },
              {},
              class: "w-full rounded-xl px-4 py-3 text-sm border border-stone-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 transition cursor-pointer" %>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-stone-700 mb-2">Current Key</label>
        <div class="px-4 py-3 rounded-xl bg-stone-50 font-mono text-sm text-stone-600">
          <%= @provider_key.key_prefix %>...
        </div>
      </div>

      <div>
        <%= form.label :api_key, "New API Key (optional)", class: "block text-sm font-medium text-stone-700 mb-2" %>
        <%= form.password_field :api_key,
            class: "w-full rounded-xl px-4 py-3 text-sm border border-stone-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 transition font-mono",
            placeholder: "Leave blank to keep current key",
            autocomplete: "off" %>
        <p class="mt-1 text-xs text-stone-500">Only enter a new key if you want to replace the existing one</p>
      </div>

      <div>
        <%= form.label :priority, class: "block text-sm font-medium text-stone-700 mb-2" %>
        <%= form.number_field :priority,
            class: "w-full rounded-xl px-4 py-3 text-sm border border-stone-200 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 transition",
            min: 0,
            max: 100 %>
        <p class="mt-1 text-xs text-stone-500">Higher priority keys are used first (0-100)</p>
      </div>

      <!-- Key Stats -->
      <div class="rounded-xl p-4 bg-stone-50 border border-stone-100">
        <h3 class="text-sm font-medium text-stone-700 mb-3">Key Statistics</h3>
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <p class="text-2xl font-semibold text-stone-900"><%= number_with_delimiter(@provider_key.usage_count) %></p>
            <p class="text-xs text-stone-500">Total Calls</p>
          </div>
          <div>
            <p class="text-2xl font-semibold text-stone-900">
              <%= @provider_key.last_used_at ? time_ago_in_words(@provider_key.last_used_at) : "Never" %>
            </p>
            <p class="text-xs text-stone-500">Last Used</p>
          </div>
          <div>
            <p class="text-2xl font-semibold text-stone-900"><%= @provider_key.global? ? "Global" : "Project" %></p>
            <p class="text-xs text-stone-500">Scope</p>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-end gap-3 pt-4 border-t border-stone-100">
        <%= link_to "Cancel", dashboard_provider_keys_path(project_id: current_project&.id),
            class: "px-4 py-2.5 text-sm font-medium text-stone-600 hover:text-stone-900 transition" %>
        <%= form.submit "Update Key",
            class: "px-6 py-2.5 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-xl transition cursor-pointer" %>
      </div>
    <% end %>
  </div>
</div>
