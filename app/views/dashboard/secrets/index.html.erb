<% content_for :title, "Secrets" %>

<div class="max-w-6xl">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="section-header">Secrets</h1>
      <p class="section-subheader">Manage encrypted secrets for <%= @current_project.name %></p>
    </div>
    <div class="flex items-center gap-3">
      <!-- Environment Selector -->
      <div class="relative" data-controller="dropdown">
        <button type="button" class="btn-secondary" data-action="click->dropdown#toggle">
          <span class="flex h-5 w-5 items-center justify-center rounded <%= @environment.locked? ? 'bg-red-100' : 'bg-emerald-100' %> mr-2">
            <svg class="h-3 w-3 <%= @environment.locked? ? 'text-red-600' : 'text-emerald-600' %>" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <% if @environment.locked? %>
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
              <% else %>
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
              <% end %>
            </svg>
          </span>
          <%= @environment.name %>
          <svg class="ml-2 h-4 w-4" style="color: var(--color-ink-400);" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
          </svg>
        </button>
        <div class="hidden absolute right-0 mt-2 w-48 rounded-xl border bg-white shadow-lg z-10" style="border-color: var(--color-cream-200);" data-dropdown-target="menu">
          <div class="py-1">
            <%# Use preloaded @environments instead of querying in view %>
            <% @environments.each do |env| %>
              <%= link_to dashboard_project_secrets_path(@current_project, environment: env.slug),
                  class: "flex items-center px-4 py-2 text-sm transition-colors hover:bg-stone-50 #{env.id == @environment.id ? 'bg-orange-50' : ''}" do %>
                <span class="flex h-5 w-5 items-center justify-center rounded <%= env.locked? ? 'bg-red-100' : 'bg-emerald-100' %> mr-2">
                  <svg class="h-3 w-3 <%= env.locked? ? 'text-red-600' : 'text-emerald-600' %>" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <% if env.locked? %>
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                    <% else %>
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                    <% end %>
                  </svg>
                </span>
                <span style="color: var(--color-ink-700);"><%= env.name %></span>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>

      <%= link_to new_dashboard_project_secret_path(@current_project), class: "btn-primary" do %>
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
        New Secret
      <% end %>
    </div>
  </div>

  <!-- Search & Filters -->
  <div class="mb-6">
    <%= form_with url: dashboard_project_secrets_path(@current_project), method: :get, class: "flex flex-wrap gap-3", data: { controller: "search", turbo_frame: "secrets_list", turbo_action: "replace" } do |f| %>
      <div class="flex-1 min-w-[200px] search-input-wrapper">
        <svg class="search-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
        </svg>
        <%= f.search_field :search, value: params[:search],
            class: "input",
            placeholder: "Search secrets...",
            data: { action: "keydown.enter->search#submit" } %>
      </div>
      <div class="w-40">
        <%= f.select :type, options_for_select([
          ["All Types", ""],
          ["Credentials", "credential"],
          ["TOTP", "totp"],
          ["HOTP", "hotp"],
          ["String", "string"],
          ["JSON", "json"],
          ["File", "file"],
          ["Certificate", "certificate"]
        ], params[:type]), {}, class: "input", data: { action: "change->search#submit" } %>
      </div>
      <%= f.hidden_field :environment, value: @environment.slug %>
      <%= f.submit "Search", class: "btn-secondary cursor-pointer" %>
    <% end %>
  </div>

  <!-- Quick Stats -->
  <% credentials_count = @secrets.count { |s| s.credential? || s.otp_enabled? } %>
  <% if credentials_count > 0 %>
    <div class="mb-6 flex items-center gap-4 text-sm" style="color: var(--color-ink-500);">
      <span class="flex items-center gap-1.5">
        <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
        <%= credentials_count %> credential<%= credentials_count == 1 ? '' : 's' %> with OTP
      </span>
      <span class="flex items-center gap-1.5">
        <span class="h-2 w-2 rounded-full" style="background: var(--color-vault);"></span>
        <%= @secrets.count - credentials_count %> standard secret<%= @secrets.count - credentials_count == 1 ? '' : 's' %>
      </span>
    </div>
  <% end %>

  <%= turbo_frame_tag "secrets_list" do %>
    <% if @secrets.any? %>
      <div class="card overflow-hidden">
        <table class="table">
          <thead>
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider" style="color: var(--color-ink-500); background: var(--color-cream-50);">Key</th>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider" style="color: var(--color-ink-500); background: var(--color-cream-50);">Type</th>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider" style="color: var(--color-ink-500); background: var(--color-cream-50);">Description</th>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider" style="color: var(--color-ink-500); background: var(--color-cream-50);">Version</th>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider" style="color: var(--color-ink-500); background: var(--color-cream-50);">Updated</th>
              <th class="px-6 py-3" style="background: var(--color-cream-50);"><span class="sr-only">Actions</span></th>
            </tr>
          </thead>
          <tbody class="divide-y" style="border-color: var(--color-cream-100);">
            <% @secrets.each do |secret| %>
              <tr class="transition-colors hover:bg-stone-50">
                <td class="whitespace-nowrap px-6 py-4">
                  <%= link_to dashboard_project_secret_path(@current_project, secret), class: "flex items-center group", data: { turbo_frame: "_top" } do %>
                    <div class="flex h-9 w-9 items-center justify-center rounded-lg transition-colors <%= secret.otp_enabled? ? 'bg-gradient-to-br from-emerald-100 to-emerald-200' : '' %>" style="<%= secret.otp_enabled? ? '' : 'background: linear-gradient(135deg, var(--color-vault-bg) 0%, var(--color-cream-200) 100%);' %>">
                      <% if secret.otp_enabled? %>
                        <svg class="h-4 w-4 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      <% elsif secret.credential? %>
                        <svg class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                      <% else %>
                        <svg class="h-4 w-4" style="color: var(--color-vault);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
                        </svg>
                      <% end %>
                    </div>
                    <span class="ml-3 text-sm font-medium transition-colors group-hover:text-orange-600" style="color: var(--color-ink-900);"><%= secret.key %></span>
                  <% end %>
                </td>
                <td class="whitespace-nowrap px-6 py-4">
                  <% case secret.secret_type %>
                  <% when "credential" %>
                    <span class="badge bg-blue-100 text-blue-700">
                      <svg class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                      </svg>
                      Credential
                    </span>
                  <% when "totp" %>
                    <span class="badge bg-emerald-100 text-emerald-700">
                      <svg class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      TOTP
                    </span>
                  <% when "hotp" %>
                    <span class="badge bg-purple-100 text-purple-700">
                      <svg class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 8.25h15m-16.5 7.5h15m-1.8-13.5l-3.9 19.5m-2.1-19.5l-3.9 19.5" />
                      </svg>
                      HOTP
                    </span>
                  <% when "json" %>
                    <span class="badge badge-neutral">JSON</span>
                  <% when "file" %>
                    <span class="badge badge-neutral">File</span>
                  <% when "certificate" %>
                    <span class="badge badge-warning">Cert</span>
                  <% else %>
                    <span class="badge badge-neutral">String</span>
                  <% end %>
                </td>
                <td class="px-6 py-4">
                  <span class="text-sm" style="color: var(--color-ink-500);"><%= truncate(secret.description, length: 40) || "â€”" %></span>
                </td>
                <td class="whitespace-nowrap px-6 py-4">
                  <span class="badge badge-neutral">v<%= secret.current_version_number %></span>
                </td>
                <td class="whitespace-nowrap px-6 py-4 text-sm" style="color: var(--color-ink-500);">
                  <%= time_ago_in_words(secret.updated_at) %> ago
                </td>
                <td class="whitespace-nowrap px-6 py-4 text-right">
                  <div class="flex items-center justify-end gap-2">
                    <% if secret.otp_enabled? %>
                      <%= link_to dashboard_project_secret_path(@current_project, secret, anchor: "otp"), class: "text-xs font-medium px-2 py-1 rounded bg-emerald-50 text-emerald-600 hover:bg-emerald-100 transition-colors", title: "View OTP", data: { turbo_frame: "_top" } do %>
                        OTP
                      <% end %>
                    <% end %>
                    <%= link_to edit_dashboard_project_secret_path(@current_project, secret), class: "text-sm font-medium transition-colors hover:text-orange-600", style: "color: var(--color-primary-500);", data: { turbo_frame: "_top" } do %>
                      Edit
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <!-- Empty State -->
      <div class="card">
        <div class="empty-state py-16">
          <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-5" style="background: linear-gradient(135deg, var(--color-vault-bg) 0%, var(--color-cream-200) 100%);">
            <svg class="w-8 h-8" style="color: var(--color-vault);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
          <h3 class="empty-state-title">No secrets</h3>
          <p class="empty-state-description">Get started by creating a new secret for the <%= @environment.name %> environment.</p>
          <div class="mt-8">
            <%= link_to new_dashboard_project_secret_path(@current_project), class: "btn-primary", data: { turbo_frame: "_top" } do %>
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
              New Secret
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
