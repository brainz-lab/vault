<%= form_with model: [@current_project, secret], url: secret.persisted? ? dashboard_project_secret_path(@current_project, secret) : dashboard_project_secrets_path(@current_project), class: "space-y-6" do |f| %>
  <% if secret.errors.any? %>
    <div class="alert alert-error">
      <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
      </svg>
      <div>
        <p class="font-medium">Please fix the following errors:</p>
        <ul class="mt-1 list-disc list-inside text-sm">
          <% secret.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <div class="card">
    <div class="card-body space-y-6">
      <!-- Environment indicator -->
      <div class="rounded-xl p-4 flex items-center justify-between" style="background: var(--color-cream-50);">
        <div class="flex items-center">
          <div class="flex h-10 w-10 items-center justify-center rounded-xl <%= @environment.locked? ? 'bg-red-100' : 'bg-emerald-100' %>">
            <svg class="h-5 w-5 <%= @environment.locked? ? 'text-red-600' : 'text-emerald-600' %>" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <% if @environment.locked? %>
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
              <% else %>
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
              <% end %>
            </svg>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium" style="color: var(--color-ink-900);"><%= @environment.name %></p>
            <p class="text-xs" style="color: var(--color-ink-500);">Current environment</p>
          </div>
        </div>
        <% if @environment.locked? %>
          <span class="badge badge-error">Locked</span>
        <% end %>
      </div>

      <!-- Key -->
      <div>
        <label for="secret_key" class="label">Key</label>
        <%= f.text_field :key, class: "input font-mono uppercase",
            placeholder: "DATABASE_URL",
            disabled: secret.persisted?,
            pattern: "[A-Z][A-Z0-9_]*" %>
        <p class="text-xs mt-1.5" style="color: var(--color-ink-400);">Must start with a letter and contain only uppercase letters, numbers, and underscores</p>
      </div>

      <!-- Secret Type -->
      <div data-controller="secret-type">
        <label for="secret_secret_type" class="label">Secret Type</label>
        <%= f.select :secret_type,
            options_for_select([
              ["Simple String", "string"],
              ["JSON", "json"],
              ["File", "file"],
              ["Certificate", "certificate"],
              ["Credential (Username/Password)", "credential"],
              ["TOTP (Time-based OTP)", "totp"],
              ["HOTP (Counter-based OTP)", "hotp"]
            ], secret.secret_type || "string"),
            {},
            class: "input",
            data: { secret_type_target: "select", action: "change->secret-type#toggle" } %>
        <p class="text-xs mt-1.5" style="color: var(--color-ink-400);">Choose the type of secret you want to store</p>


        <!-- Credential Fields (shown for credential, totp, hotp types) -->
        <div data-secret-type-target="credentialFields" class="<%= %w[credential totp hotp].include?(secret.secret_type) ? '' : 'hidden' %> mt-4 space-y-4 p-4 rounded-xl border" style="border-color: var(--color-primary-200); background: var(--color-primary-50);">
          <p class="text-sm font-medium" style="color: var(--color-primary-700);">Credential Settings</p>

          <!-- Username -->
          <div>
            <label for="secret_username" class="label">Username / Email</label>
            <%= f.text_field :username, class: "input",
                placeholder: "user@example.com" %>
          </div>
        </div>

        <!-- OTP Fields (shown for credential, totp, hotp types) -->
        <div data-secret-type-target="otpFields" class="<%= %w[credential totp hotp].include?(secret.secret_type) ? '' : 'hidden' %> mt-4 space-y-4 p-4 rounded-xl border" style="border-color: var(--color-emerald-200); background: var(--color-emerald-50);">
          <p class="text-sm font-medium" style="color: var(--color-emerald-700);">OTP Settings</p>

          <!-- OTP Secret -->
          <div>
            <label for="secret_otp_secret" class="label">OTP Secret (Base32)</label>
            <%= f.text_field :otp_secret, class: "input font-mono",
                placeholder: "JBSWY3DPEHPK3PXP" %>
            <p class="text-xs mt-1.5" style="color: var(--color-ink-400);">The base32-encoded secret from your authenticator app setup</p>
          </div>

          <!-- OTP Algorithm -->
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label for="secret_otp_algorithm" class="label">Algorithm</label>
              <%= f.select :otp_algorithm,
                  options_for_select([["SHA1", "sha1"], ["SHA256", "sha256"], ["SHA512", "sha512"]], secret.otp_algorithm || "sha1"),
                  {},
                  class: "input" %>
            </div>
            <div>
              <label for="secret_otp_digits" class="label">Digits</label>
              <%= f.select :otp_digits,
                  options_for_select([[6, 6], [7, 7], [8, 8]], secret.otp_digits || 6),
                  {},
                  class: "input" %>
            </div>
            <div data-secret-type-target="periodField">
              <label for="secret_otp_period" class="label">Period (sec)</label>
              <%= f.number_field :otp_period, class: "input",
                  value: secret.otp_period || 30,
                  min: 15, max: 120 %>
            </div>
          </div>

          <!-- OTP Issuer -->
          <div>
            <label for="secret_otp_issuer" class="label">Issuer <span class="font-normal" style="color: var(--color-ink-400);">(optional)</span></label>
            <%= f.text_field :otp_issuer, class: "input",
                placeholder: "GitHub" %>
            <p class="text-xs mt-1.5" style="color: var(--color-ink-400);">The service name that appears in authenticator apps</p>
          </div>
        </div>
      </div>

      <!-- Secret Value / Password -->
      <div data-controller="secret-type" data-secret-type-value-label-target="container">
        <label for="secret_value" class="label">
          <span data-secret-type-target="valueLabel"><%= %w[credential totp hotp].include?(secret.secret_type) ? 'Password' : 'Secret Value' %></span>
        </label>
        <%= f.text_area :value, value: @value,
            class: "input font-mono",
            rows: 4,
            placeholder: "Enter secret value..." %>
        <p class="text-xs mt-1.5 flex items-center" style="color: var(--color-ink-400);">
          <svg class="h-3.5 w-3.5 mr-1 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
          </svg>
          Value will be encrypted with AES-256-GCM
        </p>
      </div>

      <!-- Description -->
      <div>
        <label for="secret_description" class="label">Description <span class="font-normal" style="color: var(--color-ink-400);">(optional)</span></label>
        <%= f.text_field :description, class: "input",
            placeholder: "Database connection string" %>
      </div>

      <% if secret.persisted? %>
        <!-- Version Note -->
        <div>
          <label for="secret_note" class="label">Version Note <span class="font-normal" style="color: var(--color-ink-400);">(optional)</span></label>
          <%= f.text_field :note, class: "input",
              placeholder: "Reason for update..." %>
        </div>
      <% end %>

      <!-- Advanced Options -->
      <details class="group">
        <summary class="cursor-pointer text-sm font-medium transition-colors flex items-center hover:text-orange-600" style="color: var(--color-ink-700);">
          <svg class="h-4 w-4 mr-2 transform group-open:rotate-90 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
          </svg>
          Advanced Options
        </summary>
        <div class="mt-4 space-y-4 pl-6 border-l-2" style="border-color: var(--color-primary-300);">
          <div>
            <label for="secret_rotation_interval_days" class="label">Rotation Schedule (days)</label>
            <%= f.number_field :rotation_interval_days, class: "input",
                min: 1, placeholder: "90" %>
            <p class="text-xs mt-1.5" style="color: var(--color-ink-400);">Automatically remind to rotate this secret after the specified number of days</p>
          </div>
        </div>
      </details>
    </div>

    <!-- Form Actions -->
    <div class="card-footer flex justify-end gap-3">
      <%= link_to (secret.persisted? ? dashboard_project_secret_path(@current_project, secret) : dashboard_project_secrets_path(@current_project)), class: "btn-secondary" do %>
        Cancel
      <% end %>
      <%= f.submit secret.persisted? ? "Update Secret" : "Create Secret", class: "btn-primary cursor-pointer" %>
    </div>
  </div>
<% end %>
