# Kamal deployment configuration for Vault
service: vault
image: brainz/vault

servers:
  web:
    - afmp@an-ssh.brainz.computer
    - edixonhernandez@ed-ssh.brainz.computer
  job:
    hosts:
      - afmp@an-ssh.brainz.computer
      - edixonhernandez@ed-ssh.brainz.computer
    cmd: bin/jobs

proxy:
  ssl: false  # Cloudflare handles TLS termination
  host: vault.brainzlab.ai

registry:
  server: registry.digitalocean.com
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  secret:
    - RAILS_MASTER_KEY
    - DATABASE_URL
    - QUEUE_DATABASE_URL
    - CACHE_DATABASE_URL
    - CABLE_DATABASE_URL
    - SERVICE_KEY
    - VAULT_MASTER_KEY
    - CONNECTOR_SIDECAR_SECRET_KEY
  clear:
    RAILS_ENV: production
    RAILS_LOG_TO_STDOUT: "true"
    RAILS_SERVE_STATIC_FILES: "true"
    SOLID_QUEUE_IN_PUMA: "false"
    BRAINZLAB_PLATFORM_URL: https://platform.brainzlab.ai
    BRAINZLAB_PLATFORM_EXTERNAL_URL: https://platform.brainzlab.ai
    CONNECTOR_SIDECAR_URL: "http://connector-sidecar:3100"

aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole --include-password"

accessories:
  connector-sidecar:
    image: brainz/vault-connector-sidecar
    host: afmp@an-ssh.brainz.computer
    port: "3100:3100"
    env:
      clear:
        NODE_ENV: production
        PORT: "3100"
        MAX_CONCURRENT_EXECUTIONS: "10"
        EXECUTION_TIMEOUT_MS: "30000"
      secret:
        - CONNECTOR_SIDECAR_SECRET_KEY
    volumes:
      - "vault_sidecar_pieces:/app/node_modules/@activepieces"

volumes:
  - "vault_storage:/rails/storage"

# asset_path: /rails/public/assets  # Disabled for macOS - requires GNU cp

builder:
  arch: arm64

# SSH users configured per-host in servers section
